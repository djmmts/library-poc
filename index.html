<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cardano NFT Book Rental DApp</title>
</head>
<body>
	<h1>Rent a Book NFT on Cardano Preprod</h1>
	<p>Connect your wallet on Preprod network.</p>
	
	<button id="connectWallet">Connect Wallet</button>
	<p id="walletStatus"></p>

	<h2>List Rental Offer</h2>
	<label for="daily_fee">Daily Fee (lovelace):</label>
	<input type="number" id="daily_fee" min="1000000" value="1000000">
	
	<label for="min_days">Min Days:</label>
	<input type="number" id="min_days" min="1" value="1">
	
	<label for="max_days">Max Days:</label>
	<input type="number" id="max_days" min="1" value="30">
	
	<label for="auto_relist">Auto Relist:</label>
	<input type="checkbox" id="auto_relist" checked>
	
	<label for="nft_picker">Select NFT to List:</label>
	<select id="nft_picker">
		<option value="">--Select an NFT--</option>
	</select>
	
	<button id="listButton" disabled>List Rental</button>
	<p id="listStatus"></p>

	<h2>Rent Book</h2>
	<label for="rental_picker">Select Rental to Rent:</label>
	<select id="rental_picker">
		<option value="">--Select a Rental--</option>
	</select>
	
	<label for="days">Days to Rent:</label>
	<input type="number" id="days" min="1" value="1">
	
	<button id="rentButton" disabled>Rent Book</button>
	<p id="txStatus"></p>

	<!-- Load dependencies first -->
	<script src="https://unpkg.com/@emurgo/cardano-serialization-lib-browser@11.5.0/cardano_serialization_lib.min.js"></script>
	<script src="https://unpkg.com/@emurgo/cardano-message-signing-browser@1.0.1/cardano_message_signing.min.js"></script>
	
	<!-- Then load Mesh -->
	<script src="https://unpkg.com/@meshsdk/core@1.5.18/dist/index.js"></script>
	
	<script>
		// Script CBOR - add your script here
		const scriptCBOR = 'YOUR_SCRIPT_CBOR_HERE';
		const scriptAddress = 'addr_test1wzmxf4q03j25mua0wl7mh54adwnd5c97sh9fn92jzep47dsyjc380';

		// Wait for all libraries to load
		window.addEventListener('load', async () => {
			// Give it a moment for all scripts to initialize
			await new Promise(resolve => setTimeout(resolve, 500));

			// Check what's available
			console.log('Checking loaded libraries...');
			console.log('CardanoSerializationLib:', typeof CardanoSerializationLib);
			console.log('CardanoMessageSigning:', typeof CardanoMessageSigning);
			console.log('MeshJS:', typeof MeshJS);
			
			// Look for Mesh in various places
			const Mesh = window.Mesh || window.MeshJS || window.MeshSDK;
			
			if (!Mesh) {
				// If still not found, try accessing from the module
				if (window.MeshModule) {
					console.log('Found MeshModule');
				}
				
				// Last resort - check all window properties
				const meshKeys = Object.keys(window).filter(k => k.toLowerCase().includes('mesh'));
				console.log('Window properties containing "mesh":', meshKeys);
				
				document.getElementById('walletStatus').textContent = 'Error: Mesh SDK not properly loaded';
				return;
			}

			console.log('Mesh found:', Mesh);
			console.log('Available Mesh exports:', Object.keys(Mesh));

			// Now implement using whatever is available
			implementApp(Mesh);
		});

		function implementApp(Mesh) {
			const { 
				BrowserWallet, 
				Transaction, 
				BlockfrostProvider,
				resolvePaymentKeyHash,
				Data
			} = Mesh;

			let wallet;
			let walletAddress;
			const blockfrost = new BlockfrostProvider('preprod5njBajXTux1u0d7vJCH9kOgsvPCDIe6W');

			function hexToString(hex) {
				try {
					let str = '';
					for (let i = 0; i < hex.length; i += 2) {
						str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
					}
					return str;
				} catch (e) {
					return hex;
				}
			}

			// Connect wallet implementation
			document.getElementById('connectWallet').addEventListener('click', async () => {
				try {
					// Try BrowserWallet first
					if (BrowserWallet) {
						wallet = await BrowserWallet.enable('eternl');
					} else {
						// Fallback to direct window.cardano
						if (window.cardano && window.cardano.eternl) {
							const api = await window.cardano.eternl.enable();
							// Wrap in Mesh-compatible interface
							wallet = {
								getNetworkId: () => api.getNetworkId(),
								getChangeAddress: () => api.getChangeAddress(),
								getUtxos: () => api.getUtxos(),
								signTx: (tx) => api.signTx(tx),
								submitTx: (tx) => api.submitTx(tx)
							};
						} else {
							throw new Error('No Eternl wallet found');
						}
					}

					const networkId = await wallet.getNetworkId();
					if (networkId !== 0) {
						document.getElementById('walletStatus').textContent = 'Please switch to Preprod network!';
						return;
					}

					walletAddress = await wallet.getChangeAddress();
					document.getElementById('walletStatus').textContent = 'Wallet connected!';
					document.getElementById('listButton').disabled = false;
					document.getElementById('rentButton').disabled = false;

					// Populate dropdowns
					await populateNftPicker();
					await populateRentalPicker();
				} catch (error) {
					console.error('Wallet connection error:', error);
					document.getElementById('walletStatus').textContent = 'Failed to connect: ' + error.message;
				}
			});

			async function populateNftPicker() {
				// Implementation for populating NFTs
				console.log('Populating NFTs...');
				// Add your NFT population logic here
			}

			async function populateRentalPicker() {
				// Implementation for populating rentals
				console.log('Populating rentals...');
				// Add your rental population logic here
			}

			// List button handler
			document.getElementById('listButton').addEventListener('click', async () => {
				try {
					console.log('List functionality to be implemented with Mesh Transaction builder');
					document.getElementById('listStatus').textContent = 'List functionality coming soon...';
				} catch (error) {
					console.error('List error:', error);
					document.getElementById('listStatus').textContent = 'Error: ' + error.message;
				}
			});

			// Rent button handler  
			document.getElementById('rentButton').addEventListener('click', async () => {
				try {
					console.log('Rent functionality to be implemented with Mesh Transaction builder');
					document.getElementById('txStatus').textContent = 'Rent functionality coming soon...';
				} catch (error) {
					console.error('Rent error:', error);
					document.getElementById('txStatus').textContent = 'Error: ' + error.message;
				}
			});
		}
	</script>
</body>
</html>